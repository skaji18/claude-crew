# claude-crew

English version: [README.md](./README.md)

Claude CodeのTask toolを活用したマルチエージェントフレームワーク。1つのセッションで複数のサブエージェントが並列稼働し、複雑なセットアップは一切不要。

## 概要

claude-crewは、1つのClaude Codeセッションを複数のサブエージェントからなる協調チームに変える。複数のプロセスやターミナル、通信プロトコルを管理する必要はない。やりたいことを伝えるだけで、フレームワークが自動的にタスクを分解・委譲・実行・集約する。

**基本思想**: 親セッションは軽量なコーディネーターとして振る舞い、専門化されたサブエージェント間でファイルパスを受け渡すだけ。重い処理はすべてサブエージェント内で行われるため、親のコンテキスト消費は最小限に抑えられる。

### アーキテクチャ: 2層フラット構成

```
                  ┌─────────────────────────┐
                  │      親セッション         │
                  │  （コーディネーター）      │
                  └────────────┬────────────┘
                               │
            ┌──────────┬───────┼───────┬──────────┐
            ▼          ▼       ▼       ▼          ▼
        [Worker]  [Worker] [Worker] [Worker]  [Worker]
         タスク1   タスク2  タスク3  タスク4   タスク5
```

親セッションがすべてのサブエージェントを直接管理する。サブエージェントが別のサブエージェントを起動することはできない — これはプラットフォーム上の制約であり、設計上の選択ではない。

## 特徴

- **ファイルベースの通信** — サブエージェントはファイルを読み書きして連携する。親はパスだけを渡し、コンテキストウィンドウを軽量に保つ。
- **最大10並列のサブエージェント** — 独立したタスクに対して複数のWorkerを同時に起動できる。
- **ペルソナ切り替え** — 各Workerはリサーチャー、コーダー、レビュアーなどの専門的な役割を担当可能。テンプレートでカスタムペルソナも定義できる。
- **パーミッションによる安全性** — Claude Code標準のパーミッションシステムが全サブエージェントに適用される。`--dangerously-skip-permissions` は不要。
- **1サイクル完結** — 一般的なリクエスト（分解→実行→集約→回顧）は1つのコンテキストウィンドウ内で完了し、コンパクションは不要。
- **モデルの柔軟な選択** — サブエージェントごとに、軽い作業には `haiku`、標準的な作業には `sonnet`、複雑な推論には `opus` を割り当てられる。

## クイックスタート

```bash
# 1. リポジトリをクローン
git clone <repo-url> && cd claude-crew

# 2. このディレクトリでClaude Codeを起動
claude

# 3. タスクを伝える
> "Reactの状態管理ライブラリ上位5つを調査し、比較レポートを作成してください。"
```

これだけで完了。Claude Codeが `CLAUDE.md` を読み取り、フレームワークを理解して自動的に作業を統制する。

## ディレクトリ構造

```
claude-crew/
├── CLAUDE.md                  # Claude Code向けのフレームワーク指示書
├── README.md                  # 英語版README
├── config.yaml                # 実行時設定
├── CHANGELOG.md               # 変更履歴
├── .claude/
│   └── settings.json          # サブエージェントのパーミッション設定
├── templates/
│   ├── decomposer.md          # タスク分解テンプレート
│   ├── worker_default.md      # 汎用Workerテンプレート
│   ├── worker_researcher.md   # 調査特化Workerテンプレート
│   ├── worker_coder.md        # コード実装Workerテンプレート
│   ├── worker_reviewer.md     # コードレビューWorkerテンプレート
│   ├── worker_writer.md       # ドキュメント作成Workerテンプレート
│   ├── aggregator.md          # 結果集約テンプレート
│   ├── retrospector.md        # 回顧分析テンプレート
│   └── multi_analysis.md      # N観点並列分析フレームワーク
├── scripts/
│   └── new_cmd.sh             # ユーティリティスクリプト
└── work/
    └── cmd_xxx/               # リクエストごとの作業ディレクトリ
        ├── request.md
        ├── plan.md
        ├── execution_log.yaml   # 実行進捗ログ
        ├── tasks/
        │   └── task_N.md
        ├── results/
        │   └── result_N.md
        ├── report.md
        ├── report_summary.md     # 要約レポート（≤50行）
        └── retrospective.md      # 回顧分析（Phase 4で生成）
```

| パス | 役割 |
|------|------|
| `CLAUDE.md` | Claude Codeにマルチエージェントコーディネーターとしての動作方法を指示する。フレームワークの頭脳。 |
| `config.yaml` | 実行時設定: モデル選択、並列数上限、リトライ設定、Workerのタイムアウト。 |
| `.claude/settings.json` | サブエージェントがパーミッション確認なしで実行できる操作を設定する。 |
| `templates/` | 各役割の振る舞いを定義するプロンプトテンプレート。カスタマイズしてエージェントの動作を調整できる。 |
| `work/` | 実行時の作業ディレクトリ。リクエストごとにサブディレクトリが作成され、中間・最終出力がすべて格納される。 |

## 動作の仕組み

```
 人間                  親セッション              サブエージェント
   │                       │                        │
   │  "XとYを分析して"     │                        │
   ├──────────────────────>│                        │
   │                       │                        │
   │                       │── 分解役 ─────────────>│ リクエストを読み、
   │                       │<── plan.md ────────────│ 計画を作成
   │                       │                        │
   │                       │── Worker A（並列）────>│ タスク1
   │                       │── Worker B（並列）────>│ タスク2
   │                       │── Worker C（並列）────>│ タスク3
   │                       │<── resultファイル ─────│
   │                       │                        │
   │                       │── 集約役 ─────────────>│ 結果を読み、
   │                       │<── report.md ──────────│ レポートを作成
   │                       │                        │
   │                       │── 回顧役 ─────────────>│ 実行結果を分析し、
   │                       │<── retrospective.md ───│ 改善提案を作成
   │                       │                        │
   │  最終レポート         │                        │
   │<──────────────────────│                        │
```

### ステップごとの流れ

1. **リクエスト** — やりたいことを伝える。親セッションがそれを `work/cmd_NNN/request.md` に保存する。
2. **分解** — 分解役サブエージェントがリクエストを分析し、独立したタスクに分割した `plan.md` を生成する。
3. **実行** — Workerサブエージェントが並列で起動される（最大10）。各Workerがタスクファイルを読み、結果ファイルを書き出す。
4. **集約** — 集約役サブエージェントが全結果ファイルを読み、最終的な `report.md` と `report_summary.md` を生成する。
5. **回顧** — 回顧役サブエージェントが実行結果を分析し、失敗パターンと成功パターンから改善提案・スキル化提案を生成する（`config.yaml` で無効化可能）。
6. **報告** — 親セッションが最終レポートを返す。

各ステップにおける親の役割は最小限 — あるサブエージェントの出力ファイルパスを読み取り、次のサブエージェントへの入力として渡すだけ。

## テンプレート

テンプレートはサブエージェントの振る舞いを定義する。起動時にサブエージェントのコンテキストに注入されるプロンプト指示書である。

| テンプレート | 役割 | 使用場面 |
|-------------|------|---------|
| `decomposer.md` | リクエストを独立したタスクに分解 | 各サイクルの開始時に自動使用 |
| `worker_default.md` | 汎用Worker | 専門的な役割に該当しないタスク |
| `worker_researcher.md` | 情報収集と分析 | リサーチ、調査、競合分析 |
| `worker_writer.md` | ドキュメント作成・コンテンツ執筆 | README、ガイド、チュートリアル、仕様書 |
| `worker_coder.md` | コード実装 | コーディング、バグ修正、リファクタリング |
| `worker_reviewer.md` | 品質レビューとフィードバック | コードレビュー、ドキュメントレビュー、テスト |
| `aggregator.md` | 結果を最終レポートに統合 | 各サイクルの終了時に自動使用 |
| `retrospector.md` | 回顧分析・改善提案生成 | 集約後に自動使用（設定で無効化可能） |
| `multi_analysis.md` | N観点並列分析フレームワーク | 比較・評価タスク時にdecomposerが参照 |

既存テンプレートのパターンに倣って、カスタムWorkerテンプレート（例: `worker_translator.md`, `worker_designer.md`）を作成することもできる。

## 作業ディレクトリ

各リクエストは `work/` 配下に独立したサブディレクトリを作成する:

```
work/
└── cmd_001/
    ├── request.md          # 人間からの元のリクエスト
    ├── plan.md             # 分解計画（タスクと割り当て）
    ├── execution_log.yaml    # 実行進捗ログ
    ├── tasks/
    │   ├── task_1.md       # 個別タスクの定義
    │   ├── task_2.md       # 個別タスクの定義
    │   └── task_3.md       # 個別タスクの定義
    ├── results/
    │   ├── result_1.md     # タスク1のWorker出力
    │   ├── result_2.md     # タスク2のWorker出力
    │   └── result_3.md     # タスク3のWorker出力
    ├── report.md           # 最終集約レポート
    ├── report_summary.md   # 要約レポート（≤50行）
    └── retrospective.md    # 回顧分析（Phase 4で生成）
```

すべてがプレーンなMarkdownファイル。中間出力も含め、自由に閲覧・編集・再利用できる。

## 制約事項

- **ネスト不可** — サブエージェントが他のサブエージェントを起動することはできない。これはClaude Codeのプラットフォーム制約である。フレームワークは逐次フェーズ方式（分解→実行→集約→回顧）でこれを回避し、親セッションが各フェーズを橋渡しする。
- **並列上限: 最大10** — Claude Codeは最大10のサブエージェントの同時実行をサポートする。それ以上の並列が必要な場合、フレームワークが自動的にバッチ処理する。
- **ソフトなスコープ制限** — Workerのスコープはプロンプト指示で制御されており、技術的なサンドボックスではない。Workerにはアクセスすべきディレクトリが伝えられるが、これは自己申告ベースである。
- **長時間タスクにはバックグラウンド実行を推奨** — 数秒以上かかるタスクには `run_in_background: true` を使用する。親セッションは後から `TaskOutput` で結果を確認できる。
- **バックグラウンドではMCPツール使用不可** — バックグラウンドモードで実行中のサブエージェントはMCPツール（外部API連携など）を使用できない。それらのタスクはフォアグラウンドで実行すること。
- **コンテキストの独立性** — 各サブエージェントは独立した200kトークンのコンテキストウィンドウを持つ。メモリは共有されず、すべての通信はファイルを介して行われる。
- **言語方針** — `CLAUDE.md` はClaude Code向けの内部指示書として日本語で記述されている。`README.md` およびその他のユーザー向けドキュメントは英語で記述されている。

## ライセンス

MIT
